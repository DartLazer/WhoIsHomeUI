{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}


<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div class="toast bg-success text-white" role="alert" aria-live="assertive" id="liveToast" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto">Saved</strong>
            <small class="text-white"><i class="bi bi-clock"></i> Now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Settings saved
        </div>
    </div>
</div>
{% if saved_flag %}
<script type="text/javascript">
    window.onload = function () {
        var toastLiveExample = document.getElementById('liveToast');
        var toast = new bootstrap.Toast(toastLiveExample);
        toast.body = "what";
        toast.show();
    };
</script>

{% endif %}

<h3>Settings</h3>

<div id="accordion" class=" d-grid gap-3">
    <div class="card">
        
        <div class="card-header p-3" data-bs-toggle="collapse" href="#collapseScanner"  aria-expanded="true" aria-controls="collapseScanner" role="button">
            Scanner Settings
        </div>

        <div class="collapse show card-body" id="collapseScanner">

            <div class="mb-3">
                <button id="scannerButton" class="btn btn-{% if scanner_running %}success{% else %}danger{% endif %} active" id="scannerButton" onclick="scannerSwitch()">Scanner {% if scanner_running %} Running {% else %} Not Running {% endif %} 
                </button>

                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#consoleModal">View Logs</button>

            </div>

                              
            <div class="modal fade" id="consoleModal" tabindex="-1" aria-labelledby="consoleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="consoleModalLabel">Console Logs</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex flex-column">
                            {% for log in logfile %}
                            <small>{{ log }}</small>
                            {% endfor %}
                        </div>
                    </div>
                  </div>
                </div>
              </div>

            <form action="{% url 'settings' %}" method="post">
                <div class="d-grid gap-3">
                    {% csrf_token %}
                    {{ scanner_settings_form | crispy }}
                    <div class="modal-footer">
                        <br />
                        <button type="submit" class="btn btn-primary" name="update_scanner_settings">Save
                            Settings</button>
                    </div>
                </div>
            </form>
        </div>

    </div>

    <div class="card">

        <div class="card-header p-3" data-bs-toggle="collapse" href="#collapseEmail" aria-controls="collapseEmail" role="button">
            Email Settings
        </div>

        <div class="collapse card-body" id="collapseEmail">
            
            <div class="mb-3">
                In the email subjects and bodys use can use the following tags to load data into the emails:
                <ul>
                    <li>{target} for the name of the target/host</li>
                    <li>{arrival_time} time the host arrived</li>
                    <li>{departure_time} time the host left</li>
                    <li>{time_home}</li>
                    <li>{time_away}</li>
                </ul>
            </div>

            <form action="{% url 'settings' %}" method="post">
                <div class="d-grid gap-3">
                    {% csrf_token %}
                    {{ email_settings_form | crispy }}
                    <div class="modal-footer">
                        <br />
                        <button type="submit" class="btn btn-primary" name="update_email_settings">Save Settings</button>
                    </div>
                </div>
            </form>

        </div>
       
    </div>

    <div class="card">

        <div class="card-header p-3" data-bs-toggle="collapse" href="#collapseDiscord"  aria-controls="collapseDiscord" role="button">
            Discord Settings
        </div>

        <div class="collapse card-body" id="collapseDiscord">
            
            <div class="mb-3">
                In the discord message body use can use the following tags:
                <ul>
                    <li>{target} for the name of the target/host</li>
                    <li>{arrival_time} time the host arrived</li>
                    <li>{departure_time} time the host left</li>
                    <li>{time_home}</li>
                    <li>{time_away}</li>
                </ul>
            </div>

            <form action="{% url 'settings' %}" method="post">
                <div class="d-grid gap-3">
                    {% csrf_token %}
                    #TODO
                    <div class="modal-footer">
                        <br />
                        <button type="submit" class="btn btn-primary" name="update_email_settings">Save Settings</button>
                    </div>
                </div>
            </form>

        </div>

    </div>

</div>
<br/>
<br/>

<script>

    function scannerSwitch() {
        const startStopCheck = {% if scanner_running %} true {% else %} false {% endif %};
        var toastLiveExample = document.getElementById('liveToast');
        var toast = new bootstrap.Toast(toastLiveExample);
        var scannerButton = document.getElementById('scannerButton');
        if (!startStopCheck) {
            view = '/start_scanner';
            toast.show();
            scannerButton.className = 'btn btn-success';
        } else {
            view = '/stop_scanner';
            toast.show();
            scannerButton.className = 'btn btn-danger';
        }
        $.get(view,).then(() => window.location.reload());
    };


</script>

{% endblock content %}